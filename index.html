<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Braid Tone Laboratory</title>
    
    <!-- FAVICON & ICONS -->
    <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ (SVG —Å —ç–º–æ–¥–∑–∏ –∫–æ–ª–±—ã) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß™</text></svg>">
    
    <!-- Apple Touch Icon (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω iPhone/iPad) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22black%22 rx=%2220%22/><text x=%2250%%22 y=%2265%%22 font-family=%22sans-serif%22 font-weight=%22bold%22 font-size=%2250%22 fill=%22white%22 text-anchor=%22middle%22>BT</text></svg>">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Braid Tone">
    <meta name="theme-color" content="#ffffff">
    
    <!-- Tailwind & Lucide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes rotate-reset { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(180deg); } 
        }
        .animate-reset:active { animation: rotate-reset 0.3s ease-out; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .camera-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 1.5px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .camera-ring::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
        }

        .trial-overlay {
            background: radial-gradient(circle at center, rgba(255,255,255,1) 0%, rgba(248,250,252,1) 100%);
        }
    </style>
</head>
<body class="bg-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // –ò–∫–æ–Ω–∫–∏ Lucide
        const Plus = ({ size = 24, className }) => <i data-lucide="plus" style={{width: size, height: size}} className={className}></i>;
        const Minus = ({ size = 24, className }) => <i data-lucide="minus" style={{width: size, height: size}} className={className}></i>;
        const Trash2 = ({ size = 24, className }) => <i data-lucide="trash-2" style={{width: size, height: size}} className={className}></i>;
        const Save = ({ size = 24, className }) => <i data-lucide="save" style={{width: size, height: size}} className={className}></i>;
        const RotateCcw = ({ size = 24, className }) => <i data-lucide="rotate-ccw" style={{width: size, height: size}} className={className}></i>;
        const X = ({ size = 24, className }) => <i data-lucide="x" style={{width: size, height: size}} className={className}></i>;
        const Bookmark = ({ size = 24, className }) => <i data-lucide="bookmark" style={{width: size, height: size}} className={className}></i>;
        const ChevronRight = ({ size = 24, className }) => <i data-lucide="chevron-right" style={{width: size, height: size}} className={className}></i>;
        const ChevronLeft = ({ size = 24, className }) => <i data-lucide="chevron-left" style={{width: size, height: size}} className={className}></i>;
        const FlaskConical = ({ size = 24, className }) => <i data-lucide="flask-conical" style={{width: size, height: size}} className={className}></i>;
        const Lock = ({ size = 24, className }) => <i data-lucide="lock" style={{width: size, height: size}} className={className}></i>;
        const ShieldCheck = ({ size = 24, className }) => <i data-lucide="shield-check" style={{width: size, height: size}} className={className}></i>;
        const CameraIcon = ({ size = 24, className }) => <i data-lucide="camera" style={{width: size, height: size}} className={className}></i>;
        const ExternalLink = ({ size = 12, className }) => <i data-lucide="external-link" style={{width: size, height: size}} className={className}></i>;
        const Send = ({ size = 12, className }) => <i data-lucide="send" style={{width: size, height: size}} className={className}></i>;

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBk99RmIn2McXhLlMV4huc2iTUGONc7Zig",
            authDomain: "rootscalc-1c302.firebaseapp.com",
            projectId: "rootscalc-1c302",
            storageBucket: "rootscalc-1c302.firebasestorage.app",
            messagingSenderId: "466620468252",
            appId: "1:466620468252:web:e65ad3b731f4315f06a3d9"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const getDeviceId = () => {
            let id = localStorage.getItem('bt_device_id');
            if (!id) {
                id = Math.random().toString().slice(2, 12);
                localStorage.setItem('bt_device_id', id);
            }
            return id;
        };

        const App = () => {
            // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞
            const initialBaseColors = [
                { id: '1', name: '1', desc: '–ì–ª—É–±–æ–∫–∏–π —á–µ—Ä–Ω—ã–π', hex: '#000000' },
                { id: '1B', name: '1B', desc: '–ß–µ—Ä–Ω—ã–π –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π (–º—è–≥–∫–∏–π)', hex: '#1A1714' },
                { id: '2', name: '2', desc: '–¢–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π (–≥–æ—Ä—å–∫–∏–π —à–æ–∫–æ–ª–∞–¥)', hex: '#2B1E16' },
                { id: '3', name: '3', desc: '–¢–µ–º–Ω—ã–π —à–∞—Ç–µ–Ω', hex: '#36281F' },
                { id: '4', name: '4', desc: '–¢–µ–º–Ω—ã–π —à–æ–∫–æ–ª–∞–¥', hex: '#3B2B23' },
                { id: '6', name: '6', desc: '–ö–∞—à—Ç–∞–Ω–æ–≤—ã–π —à–æ–∫–æ–ª–∞–¥', hex: '#4E342E' },
                { id: '8', name: '8', desc: '–¢–µ–º–Ω–æ-—Ä—É—Å—ã–π —Ç–µ–ø–ª—ã–π', hex: '#6D4C41' },
                { id: '9', name: '9', desc: '–°–≤–µ—Ç–ª–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π', hex: '#7B5C41' },
                { id: '10', name: '10', desc: '–†—É—Å—ã–π (–∫–ª–∞—Å—Å–∏–∫–∞)', hex: '#A68B67' },
                { id: '18N', name: '18N', desc: '–†—É—Å—ã–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (—Ö–æ–ª–æ–¥–Ω–æ–≤–∞—Ç—ã–π)', hex: '#8B7D6B' },
                { id: '19', name: '19', desc: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ-—Ä—É—Å—ã–π', hex: '#B59A7A' },
                { id: '22', name: '22', desc: '–ü–µ–ø–µ–ª—å–Ω—ã–π –±–ª–æ–Ω–¥–∏–Ω', hex: '#D2B48C' },
                { id: '24', name: '24', desc: '–ü—à–µ–Ω–∏—á–Ω—ã–π –±–ª–æ–Ω–¥–∏–Ω', hex: '#D6B87D' },
                { id: '27', name: '27', desc: '–ú–µ–¥–æ–≤—ã–π –±–ª–æ–Ω–¥', hex: '#C68E3D' },
                { id: '30', name: '30', desc: '–°–≤–µ—Ç–ª–æ-–∫–∞—à—Ç–∞–Ω–æ–≤—ã–π', hex: '#8B4513' },
                { id: '33', name: '33', desc: '–¢–µ–º–Ω—ã–π –º–∞—Ö–∞–≥–æ–Ω (–∫–æ–Ω—å—è—á–Ω—ã–π)', hex: '#4B211C' },
                { id: '60', name: '60', desc: '–ú–æ–ª–æ—á–Ω—ã–π (—Å–ª–æ–Ω–æ–≤–∞—è –∫–æ—Å—Ç—å)', hex: '#FAF9F6' },
                { id: '87', name: '87', desc: '–ñ–µ–ª—Ç—ã–π –±–ª–æ–Ω–¥', hex: '#F0E68C' },
                { id: '101', name: '101', desc: '–ü–µ–ø–µ–ª (—Å–µ—Ä–µ–±—Ä–∏—Å—Ç–æ-—Å–µ—Ä—ã–π)', hex: '#C1C5C9' },
                { id: '135S', name: '135S', desc: '–ö—Ä–∞—Å–Ω–æ-—Ä—ã–∂–∏–π', hex: '#913129' },
                { id: '144', name: '144', desc: '–ì–æ—Ä—á–∏—á–Ω—ã–π / –¢–µ–º–Ω–æ-–∑–æ–ª–æ—Ç–æ–π', hex: '#D99100' },
                { id: '220', name: '220', desc: '–ë–µ–∂–µ–≤—ã–π –±–ª–æ–Ω–¥', hex: '#E1C699' },
                { id: '301', name: '301', desc: '–ú–∏–∫—Å —Å–≤–µ—Ç–ª–æ-—Ä—É—Å—ã–π', hex: '#BFA075' },
                { id: '302', name: '302', desc: '–ú–∏–∫—Å —Å—Ä–µ–¥–Ω–µ-—Ä—É—Å—ã–π', hex: '#997950' },
                { id: '303', name: '303', desc: '–ú–∏–∫—Å —Ç–µ–º–Ω–æ-—Ä—É—Å—ã–π', hex: '#735438' },
                { id: '307', name: '307', desc: '–ú–∏–∫—Å –º–µ–¥–Ω–æ-–∑–æ–ª–æ—Ç–∏—Å—Ç—ã–π', hex: '#A0522D' },
                { id: '600', name: '600', desc: '–û—Å–ª–µ–ø–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–π', hex: '#FFFFFF' },
                { id: '600-1', name: '600-1', desc: '–•–æ–ª–æ–¥–Ω—ã–π –±–µ–ª—ã–π', hex: '#F0F8FF' },
                { id: '600-3', name: '600-3', desc: '–¢–µ–ø–ª—ã–π –±–µ–ª—ã–π (–±–µ–∂–µ–≤—ã–π –ø–æ–¥—Ç–æ–Ω)', hex: '#F5F5DC' },
                { id: '613', name: '613', desc: '–°–≤–µ—Ç–ª—ã–π –±–ª–æ–Ω–¥ (–ø–ª–∞—Ç–∏–Ω–∞)', hex: '#F3E5AB' },
                { id: 'KB-88', name: 'KB-88', desc: '–ó–æ–ª–æ—Ç–∏—Å—Ç—ã–π –±–ª–æ–Ω–¥', hex: '#E7BC5F' },
                { id: 'F1', name: 'F1', desc: '–†–æ–∑–æ–≤—ã–π (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)', hex: '#FF6699' },
                { id: 'F2', name: 'F2', desc: '–ö—Ä–∞—Å–Ω—ã–π (–∞–ª—ã–π)', hex: '#D10000' },
                { id: 'F10', name: 'F10', desc: '–¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π', hex: '#000080' },
                { id: 'F11', name: 'F11', desc: '–ë–∞–∫–ª–∞–∂–∞–Ω (—Ç–µ–º–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç)', hex: '#483248' },
                { id: 'F12', name: 'F12', desc: '–ù–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', hex: '#6A0DAD' },
                { id: 'F13', name: 'F13', desc: '–õ–∞–≤–∞–Ω–¥–æ–≤—ã–π', hex: '#9370DB' },
                { id: 'F14', name: 'F14', desc: '–Ø—Ä–∫–æ-—Å–∏–Ω–∏–π', hex: '#0033CC' },
                { id: 'F15', name: 'F15', desc: '–û—Ä–∞–Ω–∂–µ–≤—ã–π (—è—Ä–∫–∏–π)', hex: '#FF8300' },
                { id: 'F16', name: 'F16', desc: '–ù–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π', hex: '#A2CFFE' },
                { id: 'F17', name: 'F17', desc: '–°–æ–ª–Ω–µ—á–Ω–æ-–∂–µ–ª—Ç—ã–π', hex: '#FFEF00' },
                { id: 'F18', name: 'F18', desc: '–°–∞–ª–∞—Ç–æ–≤—ã–π –Ω–µ–æ–Ω', hex: '#7FFF00' },
                { id: 'F19', name: 'F19', desc: '–¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π', hex: '#008000' },
                { id: 'F20', name: 'F20', desc: '–†—ã–∂–µ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π (–∫–∏—Ä–ø–∏—á)', hex: '#CC4E00' },
                { id: 'F21', name: 'F21', desc: '–°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π (–ø–µ—Ä—Å–∏–∫)', hex: '#FFB07C' },
                { id: 'F24', name: 'F24', desc: '–†–æ–∑–æ–≤—ã–π –Ω–µ–æ–Ω (—Ñ—É–∫—Å–∏—è)', hex: '#FF33CC' },
                { id: 'F25', name: 'F25', desc: '–ù–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π', hex: '#FFC0CB' },
                { id: 'F26', name: 'F26', desc: '–ö–æ—Ä–∞–ª–ª', hex: '#FF7F50' },
                { id: 'F27', name: 'F27', desc: '–ë–æ—Ä–¥–æ–≤—ã–π (–≤–∏–Ω–æ)', hex: '#800000' },
                { id: 'F31', name: 'F31', desc: '–ú—è—Ç–Ω—ã–π', hex: '#AAF0D1' },
            ];

            const [isActivated, setIsActivated] = useState(() => localStorage.getItem('bt_activated') === 'true');
            const [baseColors, setBaseColors] = useState(() => JSON.parse(localStorage.getItem('bt_baseColors')) || initialBaseColors);
            const [mixList, setMixList] = useState(() => JSON.parse(localStorage.getItem('bt_mixList')) || []);
            const [savedMixes, setSavedMixes] = useState(() => JSON.parse(localStorage.getItem('bt_savedMixes')) || []);

            const [timeLeft, setTimeLeft] = useState(() => {
                const savedEnd = localStorage.getItem('bt_trial_end');
                if (!savedEnd) {
                    const end = Date.now() + 180000;
                    localStorage.setItem('bt_trial_end', end);
                    return 180;
                }
                return Math.max(0, Math.floor((parseInt(savedEnd) - Date.now()) / 1000));
            });

            const [activationKey, setActivationKey] = useState('');
            const [isActivating, setIsActivating] = useState(false);
            const [activationError, setActivationError] = useState('');

            const [isAddingNew, setIsAddingNew] = useState(false);
            const [isNamingMix, setIsNamingMix] = useState(false);
            const [mixName, setMixName] = useState('');
            const [newColor, setNewColor] = useState({ name: '', hex: '#ff5722', desc: '' });
            const [deleteModeId, setDeleteModeId] = useState(null);

            const [isCameraActive, setIsCameraActive] = useState(false);
            const [cameraStream, setCameraStream] = useState(null);
            const [liveHex, setLiveHex] = useState('#ffffff');
            
            const videoRef = useRef(null);
            const hiddenCanvasRef = useRef(null);
            const canvasHairRef = useRef(null);
            const canvasThreadsRef = useRef(null);
            const scrollContainerRef = useRef(null);
            const longPressTimer = useRef(null);

            useEffect(() => {
                localStorage.setItem('bt_baseColors', JSON.stringify(baseColors));
                localStorage.setItem('bt_mixList', JSON.stringify(mixList));
                localStorage.setItem('bt_savedMixes', JSON.stringify(savedMixes));
                localStorage.setItem('bt_activated', isActivated);
            }, [baseColors, mixList, savedMixes, isActivated]);

            useEffect(() => {
                if (isActivated || timeLeft <= 0) return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        const next = prev - 1;
                        if (next <= 0) clearInterval(timer);
                        return next;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [timeLeft, isActivated]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const stopCamera = useCallback(() => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    setCameraStream(null);
                }
                setIsCameraActive(false);
            }, [cameraStream]);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: 480, height: 480 }, 
                        audio: false 
                    });
                    setCameraStream(stream);
                    setIsCameraActive(true);
                } catch (err) {
                    console.error("Camera access denied");
                }
            };

            useEffect(() => {
                if (isCameraActive && cameraStream && videoRef.current) {
                    videoRef.current.srcObject = cameraStream;
                    videoRef.current.play().catch(e => console.log(e));
                }
            }, [isCameraActive, cameraStream]);

            useEffect(() => {
                let raf;
                const analyze = () => {
                    if (isCameraActive && videoRef.current && hiddenCanvasRef.current) {
                        const video = videoRef.current;
                        const canvas = hiddenCanvasRef.current;
                        if (video.readyState >= 2) {
                            const ctx = canvas.getContext('2d', { willReadFrequently: true });
                            ctx.drawImage(video, video.videoWidth/2, video.videoHeight/2, 1, 1, 0, 0, 1, 1);
                            const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                            const hex = "#" + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
                            setLiveHex(hex);
                        }
                    }
                    raf = requestAnimationFrame(analyze);
                };
                if (isCameraActive) raf = requestAnimationFrame(analyze);
                return () => cancelAnimationFrame(raf);
            }, [isCameraActive]);

            const closeAddModal = () => {
                stopCamera();
                setIsAddingNew(false);
                setNewColor({ name: '', hex: '#ff5722', desc: '' });
            };

            const handleActivation = async () => {
                if (!activationKey.trim()) return;
                setIsActivating(true);
                setActivationError('');
                try {
                    const deviceId = getDeviceId();
                    const keysRef = db.collection('artifacts/rootscalc-pro/public/data/keys');
                    const snapshot = await keysRef.where('key', '==', activationKey.trim().toUpperCase()).get();
                    if (snapshot.empty) {
                        setActivationError('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á');
                    } else {
                        const keyDoc = snapshot.docs[0];
                        const keyData = keyDoc.data();
                        if (keyData.deviceId && keyData.deviceId !== deviceId) {
                            setActivationError('–ö–ª—é—á —É–∂–µ –∑–∞–Ω—è—Ç');
                        } else {
                            await keysRef.doc(keyDoc.id).update({ deviceId: deviceId });
                            setIsActivated(true);
                        }
                    }
                } catch (err) {
                    setActivationError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                } finally {
                    setIsActivating(false);
                }
            };

            const hexToRgb = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return { r, g, b };
            };

            const getBrightness = (hex) => {
                const { r, g, b } = hexToRgb(hex);
                return (r * 299 + g * 587 + b * 114) / 1000;
            };

            const getAverageColor = () => {
                if (mixList.length === 0) return '#fafafa';
                let r = 0, g = 0, b = 0;
                const total = mixList.reduce((s, i) => s + i.weight, 0);
                mixList.forEach(item => {
                    const rgb = hexToRgb(item.hex);
                    r += rgb.r * (item.weight / total);
                    g += rgb.g * (item.weight / total);
                    b += rgb.b * (item.weight / total);
                });
                const toHex = (c) => Math.round(c).toString(16).padStart(2, '0');
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            };

            // –õ–æ–≥–∏–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤–æ–ª–æ—Å –∏ –¥—Ä–µ–¥–æ–≤
            useEffect(() => {
                const hairCanvas = canvasHairRef.current;
                const threadsCanvas = canvasThreadsRef.current;
                if (!hairCanvas || !threadsCanvas) return;
                const ctxH = hairCanvas.getContext('2d', { alpha: false });
                const ctxT = threadsCanvas.getContext('2d', { alpha: false });
                const w = hairCanvas.width;
                const h = hairCanvas.height;
                if (mixList.length === 0) {
                    const emptyColor = '#fafafa';
                    [ctxH, ctxT].forEach(ctx => { ctx.fillStyle = emptyColor; ctx.fillRect(0, 0, w, h); });
                    return;
                }
                const totalWeight = mixList.reduce((sum, item) => sum + item.weight, 0);
                const sortedActive = [...mixList].sort((a, b) => getBrightness(a.hex) - getBrightness(b.hex));
                const backgroundHex = sortedActive[0].hex;
                ctxH.fillStyle = backgroundHex;
                ctxH.fillRect(0, 0, w, h);
                const hairCount = 1000;
                let colorPool = [];
                mixList.forEach(item => {
                    const count = Math.round((item.weight / (totalWeight || 1)) * hairCount);
                    for (let i = 0; i < count; i++) colorPool.push(item.hex);
                });
                for (let i = colorPool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [colorPool[i], colorPool[j]] = [colorPool[j], colorPool[i]];
                }
                colorPool.forEach((color, i) => {
                    ctxH.strokeStyle = color; ctxH.lineWidth = 1.2; ctxH.globalAlpha = 0.8;
                    const startX = i * (w / hairCount);
                    ctxH.beginPath(); ctxH.moveTo(startX, 0);
                    ctxH.bezierCurveTo(startX + (Math.random()-0.5)*10, h*0.4, startX + (Math.random()-0.5)*10, h*0.7, startX + (Math.random()-0.5)*5, h);
                    ctxH.stroke();
                });
                ctxT.fillStyle = backgroundHex;
                ctxT.fillRect(0, 0, w, h);
                const baseThreadCount = 80000;
                mixList.forEach(item => {
                    const share = item.weight / (totalWeight || 1);
                    const count = Math.floor(baseThreadCount * share);
                    ctxT.strokeStyle = item.hex; ctxT.globalAlpha = 0.25 + (share * 0.35); ctxT.lineWidth = 0.5;
                    for (let i = 0; i < count; i++) {
                        const x = Math.random() * w; const y = Math.random() * h;
                        ctxT.beginPath(); ctxT.moveTo(x, y);
                        const cp1x = x + (Math.random()-0.5)*40; const cp1y = y + (Math.random()-0.5)*40;
                        const ex = x + (Math.random()-0.5)*20; const ey = y + (Math.random()-0.5)*20;
                        ctxT.quadraticCurveTo(cp1x, cp1y, ex, ey); ctxT.stroke();
                    }
                });
                [ctxH, ctxT].forEach(ctx => {
                    ctx.globalAlpha = 1.0;
                    const highlight = ctx.createLinearGradient(0, 0, w, 0);
                    highlight.addColorStop(0, 'rgba(255,255,255,0)'); highlight.addColorStop(0.5, 'rgba(255,255,255,0.1)'); highlight.addColorStop(1, 'rgba(255,255,255,0)');
                    ctx.fillStyle = highlight; ctx.fillRect(0, 0, w, h);
                });
            }, [mixList]);

            const addToMix = (color) => {
                if (deleteModeId) { setDeleteModeId(null); return; }
                const existing = mixList.find(i => i.id === color.id);
                if (existing) updateWeight(color.id, 50);
                else setMixList([...mixList, { ...color, weight: 100 }]);
            };

            const updateWeight = (id, delta) => {
                setMixList(prev => prev.map(item => 
                    item.id === id ? { ...item, weight: Math.max(0, item.weight + delta) } : item
                ).filter(item => item.weight > 0));
            };

            const saveMix = () => {
                if (mixList.length === 0) return;
                const defaultName = mixList.map(i => i.name).join('+');
                const newMix = {
                    id: Date.now(),
                    name: mixName.trim() || defaultName,
                    timestamp: new Date().toLocaleDateString(),
                    totalWeight: mixList.reduce((s, i) => s + i.weight, 0),
                    components: [...mixList],
                    previewColor: getAverageColor()
                };
                setSavedMixes([newMix, ...savedMixes]);
                setIsNamingMix(false);
                setMixName('');
            };

            const groupedColors = useMemo(() => {
                const res = [];
                for (let i = 0; i < baseColors.length; i += 10) res.push(baseColors.slice(i, i + 10));
                return res;
            }, [baseColors]);

            return (
                <div className="min-h-screen bg-white text-slate-900 font-sans antialiased pb-24 select-none overflow-x-hidden">
                    
                    {/* Trial End Overlay */}
                    {!isActivated && timeLeft <= 0 && (
                        <div className="fixed inset-0 z-[1000] trial-overlay flex flex-col items-center justify-center p-10 text-center fade-in">
                            <div className="w-28 h-28 bg-[#09090b] rounded-[2.2rem] flex items-center justify-center mb-12 shadow-xl">
                                <Lock size={44} className="text-white" />
                            </div>
                            
                            <h2 className="text-[26px] font-extrabold uppercase tracking-tight mb-6 text-[#09090b]">–¢—Ä–∏–∞–ª –æ–∫–æ–Ω—á–µ–Ω</h2>
                            
                            <p className="text-[14px] leading-[1.6] text-slate-400 font-medium max-w-[280px] mb-12">
                                –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
                            </p>

                            <div className="w-full max-w-[320px] space-y-4">
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        value={activationKey} 
                                        onChange={(e) => setActivationKey(e.target.value)} 
                                        placeholder="–í–í–ï–î–ò–¢–ï –ö–õ–Æ–ß" 
                                        className="w-full bg-[#f1f3f7] border-none rounded-[1.2rem] py-6 px-6 text-center text-[13px] font-bold uppercase tracking-widest outline-none placeholder:text-slate-300 transition-all" 
                                    />
                                </div>
                                
                                <button 
                                    onClick={handleActivation} 
                                    className="w-full py-6 bg-[#808389] text-white rounded-[1.2rem] text-[13px] font-bold uppercase tracking-widest shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all"
                                >
                                    {isActivating ? '...' : <><ShieldCheck size={18} strokeWidth={2.5}/> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</>}
                                </button>
                                
                                {activationError && <p className="text-[10px] text-red-500 font-bold uppercase pt-2">{activationError}</p>}
                            </div>

                            {/* –ê–∫—Ç–∏–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –¢–µ–ª–µ–≥—Ä–∞–º */}
                            <a href="https://t.me/televnoy" target="_blank" className="mt-10 px-6 py-4 rounded-3xl bg-blue-50 text-blue-600 text-[11px] font-black uppercase tracking-widest flex items-center gap-3 border border-blue-100 active:bg-blue-100 transition-all shadow-sm">
                                <Send size={16}/> –ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏: @televnoy <ExternalLink size={12}/>
                            </a>

                            <div className="absolute bottom-10 text-[9px] font-bold text-slate-300 uppercase tracking-widest">
                                ID: {getDeviceId()}
                            </div>
                        </div>
                    )}

                    <header className="max-w-xl mx-auto px-6 py-4 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur-md z-50 border-b border-slate-50">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-slate-950 rounded-xl flex items-center justify-center shadow-lg border border-slate-800">
                                <div className="text-white font-black text-xs">BT</div>
                            </div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight uppercase leading-none">Braid Tone</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <p className="text-[9px] uppercase tracking-[0.3em] text-slate-400 font-bold">Laboratory</p>
                                    {!isActivated && timeLeft > 0 && <div className="px-1.5 py-0.5 bg-slate-950 rounded text-[8px] font-black text-white uppercase">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>}
                                    {isActivated && <div className="flex items-center gap-1 text-[8px] font-black text-emerald-500 uppercase tracking-widest"><ShieldCheck size={10}/> Pro</div>}
                                </div>
                            </div>
                        </div>
                        <button onClick={() => setIsAddingNew(true)} className="w-12 h-12 flex items-center justify-center rounded-2xl bg-slate-50 border border-slate-100 text-slate-950 active:scale-90 transition-all"><Plus size={24}/></button>
                    </header>

                    <main className="max-w-xl mx-auto px-6 space-y-8 mt-6">
                        {/* –ü–∞–ª–∏—Ç—Ä–∞ */}
                        <section className="relative">
                            <div className="flex justify-between items-center mb-4 px-1">
                                <span className="text-[10px] font-black uppercase tracking-widest text-slate-400">–ü–∞–ª–∏—Ç—Ä–∞ (–∑–∞–∂–º–∏—Ç–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)</span>
                                <div className="flex gap-2">
                                    <button onClick={() => scrollContainerRef.current?.scrollBy({left:-300, behavior:'smooth'})} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400"><ChevronLeft size={16}/></button>
                                    <button onClick={() => scrollContainerRef.current?.scrollBy({left:300, behavior:'smooth'})} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400"><ChevronRight size={16}/></button>
                                </div>
                            </div>
                            <div ref={scrollContainerRef} className="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide scroll-smooth">
                                {groupedColors.map((group, idx) => (
                                    <div key={idx} className="min-w-full snap-start grid grid-cols-5 grid-rows-2 gap-3 pb-2 pr-1">
                                        {group.map(color => (
                                            <div key={color.id} className="relative flex flex-col items-center gap-1" onMouseDown={() => { longPressTimer.current = setTimeout(() => setDeleteModeId(color.id), 800); }} onMouseUp={() => clearTimeout(longPressTimer.current)} onTouchStart={() => { longPressTimer.current = setTimeout(() => setDeleteModeId(color.id), 800); }} onTouchEnd={() => clearTimeout(longPressTimer.current)}>
                                                <button onClick={() => addToMix(color)} className={`w-full aspect-square rounded-xl border border-slate-100 shadow-sm transition-all active:scale-90 ${deleteModeId === color.id ? 'scale-90 opacity-50 ring-2 ring-red-500' : ''}`} style={{ backgroundColor: color.hex }} />
                                                <span className="text-[9px] font-black text-slate-900 leading-none">{color.name}</span>
                                                {deleteModeId === color.id && (
                                                    <button onClick={() => { setBaseColors(prev => prev.filter(c => c.id !== color.id)); setDeleteModeId(null); }} className="absolute -top-2 -right-2 w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg z-10"><X size={14} strokeWidth={4} /></button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è */}
                        <section className="grid grid-cols-2 gap-4">
                            <div className="space-y-3">
                                <div className="aspect-[3/4] rounded-[2rem] bg-slate-50 border border-slate-100 overflow-hidden shadow-inner ring-4 ring-slate-50/50">
                                    <canvas ref={canvasHairRef} width={400} height={533} className="w-full h-full object-cover" />
                                </div>
                                <p className="text-[9px] text-center font-black uppercase tracking-widest text-slate-400">–≤ –∫–æ—Å–µ</p>
                            </div>
                            <div className="space-y-3">
                                <div className="aspect-[3/4] rounded-[2rem] bg-slate-50 border border-slate-100 overflow-hidden shadow-inner ring-4 ring-slate-50/50">
                                    <canvas ref={canvasThreadsRef} width={400} height={533} className="w-full h-full object-cover" />
                                </div>
                                <p className="text-[9px] text-center font-black uppercase tracking-widest text-slate-400">–≤ –¥—Ä–µ–¥–µ</p>
                            </div>
                        </section>

                        <div className="bg-white p-4 rounded-[2.5rem] border border-slate-100 shadow-sm">
                             <div className="flex justify-between items-center px-2 mb-3">
                                    <div className="flex items-center gap-2">
                                         <FlaskConical size={14} className="text-slate-950" />
                                         <span className="text-[10px] font-black uppercase tracking-widest">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
                                    </div>
                                    <span className="text-[10px] font-mono font-bold text-slate-400 uppercase">{getAverageColor()}</span>
                             </div>
                             <div className="h-14 w-full rounded-2xl shadow-inner border border-slate-50 transition-colors duration-500" style={{ backgroundColor: getAverageColor() }} />
                        </div>

                        {/* –§–æ—Ä–º—É–ª–∞ */}
                        <section className="space-y-4">
                            <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-950 border-b border-slate-50 pb-2 flex justify-between">
                                <span>–§–æ—Ä–º—É–ª–∞ —Å–º–µ—à–∫–∏</span>
                                <span className="text-slate-300">–í—Å–µ–≥–æ: {mixList.reduce((s,i) => s + i.weight, 0)}–≥</span>
                            </h2>
                            <div className="space-y-3">
                                {mixList.map((item) => (
                                    <div key={item.id} className="bg-slate-50/50 rounded-3xl p-4 border border-slate-50 flex items-center gap-4">
                                        <div className="w-14 h-14 rounded-2xl border border-white shadow-sm flex-shrink-0" style={{ backgroundColor: item.hex }} />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-xs font-black text-slate-950 uppercase">{item.name}</p>
                                            <p className="text-[9px] font-black text-slate-400 uppercase mt-1 truncate">{item.desc}</p>
                                        </div>
                                        <div className="flex items-center bg-white rounded-2xl border border-slate-100 p-1">
                                            <button onClick={() => updateWeight(item.id, -5)} className="w-8 h-8 flex items-center justify-center text-slate-300"><Minus size={14}/></button>
                                            <input type="number" className="w-10 text-center text-xs font-black bg-transparent outline-none p-0" value={item.weight} onChange={(e) => {
                                                const val = parseInt(e.target.value) || 0;
                                                setMixList(prev => prev.map(m => m.id === item.id ? {...m, weight: val} : m));
                                            }} />
                                            <button onClick={() => updateWeight(item.id, 5)} className="w-8 h-8 flex items-center justify-center text-slate-300"><Plus size={14}/></button>
                                        </div>
                                        <button onClick={() => setMixList(mixList.filter(m => m.id !== item.id))} className="text-slate-200 hover:text-red-500 transition-colors"><Trash2 size={18} /></button>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <div className="flex gap-4">
                            <button disabled={mixList.length === 0} onClick={() => setIsNamingMix(true)} className="flex-1 h-20 bg-slate-950 text-white rounded-[2rem] text-[10px] font-black uppercase tracking-widest shadow-xl active:scale-95 disabled:opacity-20 flex items-center justify-center gap-3"><Save size={20} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button onClick={() => setMixList([])} className="w-20 h-20 flex items-center justify-center rounded-[2rem] bg-slate-100 text-slate-300 animate-reset transition-all"><RotateCcw size={24} /></button>
                        </div>

                        {/* –ò—Å—Ç–æ—Ä–∏—è */}
                        {savedMixes.length > 0 && (
                            <section className="pt-8 border-t border-slate-50 space-y-4 pb-10">
                                <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400 px-1 flex items-center gap-2">
                                    <Bookmark size={14}/> –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ—à–µ–∫
                                </h2>
                                {savedMixes.map(mix => (
                                    <div key={mix.id} onClick={() => setMixList(mix.components)} className="p-5 rounded-[2rem] bg-white border border-slate-100 flex items-center gap-4 cursor-pointer hover:border-slate-300 transition-all group shadow-sm">
                                        <div className="w-12 h-12 rounded-full border border-slate-100 shadow-sm" style={{ backgroundColor: mix.previewColor }} />
                                        <div className="flex-1 min-w-0">
                                            <p className="text-[10px] font-black uppercase truncate text-slate-900">{mix.name}</p>
                                            <p className="text-[8px] text-slate-400 font-bold uppercase mt-1">{mix.totalWeight}–≥ ‚Ä¢ {mix.timestamp}</p>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); setSavedMixes(savedMixes.filter(m => m.id !== mix.id)); }} className="text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Trash2 size={18} /></button>
                                        <ChevronRight size={16} className="text-slate-200" />
                                    </div>
                                ))}
                            </section>
                        )}
                    </main>

                    {/* –ú–æ–¥–∞–ª–∫–∞ —Å –∫–∞–º–µ—Ä–æ–π */}
                    {isAddingNew && (
                        <div className="fixed inset-0 bg-white z-[100] flex flex-col p-8 fade-in" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-10">
                                <h3 className="text-[11px] font-black uppercase tracking-[0.2em] text-slate-300">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Ç–µ–Ω–æ–∫</h3>
                                <button onClick={closeAddModal} className="w-10 h-10 flex items-center justify-center text-slate-950 bg-slate-50 rounded-full active:scale-90 transition-all"><X size={22}/></button>
                            </div>

                            <div className="flex-1 flex flex-col items-center justify-center max-w-sm mx-auto w-full">
                                <div className="relative w-full aspect-square max-w-[280px] rounded-[3rem] overflow-hidden border border-slate-50 shadow-sm mb-12 bg-slate-50">
                                    {isCameraActive ? (
                                        <>
                                            <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" />
                                            <div className="camera-ring"></div>
                                            <button 
                                                onClick={() => { setNewColor({...newColor, hex: liveHex}); stopCamera(); }} 
                                                className="absolute bottom-6 left-1/2 -translate-x-1/2 h-14 px-8 bg-white text-slate-950 rounded-2xl shadow-xl flex items-center gap-3 active:scale-90 transition-all"
                                            >
                                                <div className="w-4 h-4 rounded-full border border-slate-100" style={{backgroundColor: liveHex}}></div>
                                                <span className="text-[10px] font-black uppercase tracking-widest">–ó–∞—Ö–≤–∞—Ç</span>
                                            </button>
                                        </>
                                    ) : (
                                        <div className="w-full h-full flex flex-col items-center justify-center gap-6">
                                            <div className="w-16 h-16 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center text-slate-200">
                                                <CameraIcon size={32} />
                                            </div>
                                            <button onClick={startCamera} className="px-8 py-3 bg-slate-950 text-white rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-all">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
                                        </div>
                                    )}
                                </div>

                                <div className="w-full space-y-8">
                                    <div className="grid grid-cols-[1fr_auto] gap-6 items-end">
                                        <div className="space-y-6">
                                            <input className="w-full border-b border-slate-100 py-3 text-sm font-black outline-none focus:border-slate-950 uppercase" placeholder="–ö–û–î –¶–í–ï–¢–ê" value={newColor.name} onChange={e => setNewColor({...newColor, name: e.target.value})} />
                                            <input className="w-full border-b border-slate-100 py-3 text-[10px] font-bold outline-none focus:border-slate-950 uppercase text-slate-400" placeholder="–û–ü–ò–°–ê–ù–ò–ï" value={newColor.desc} onChange={e => setNewColor({...newColor, desc: e.target.value})} />
                                        </div>
                                        <div className="w-16 h-16 rounded-[1.2rem] border border-slate-100 shadow-inner relative overflow-hidden" style={{ backgroundColor: newColor.hex }}>
                                            <input type="color" className="absolute inset-0 opacity-0 cursor-pointer w-full h-full" value={newColor.hex} onChange={e => setNewColor({...newColor, hex: e.target.value})} />
                                        </div>
                                    </div>
                                    <button onClick={() => { if(newColor.name) { setBaseColors([{...newColor, id: Date.now().toString()}, ...baseColors]); closeAddModal(); } }} className="w-full py-6 bg-slate-950 text-white rounded-[1.8rem] text-[11px] font-black uppercase tracking-widest shadow-xl active:scale-95">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–ª–∏—Ç—Ä—É</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isNamingMix && (
                        <div className="fixed inset-0 bg-slate-950/10 backdrop-blur-xl z-[100] flex items-center justify-center p-6" onClick={() => setIsNamingMix(false)}>
                            <div className="w-full max-w-sm bg-white rounded-[2.5rem] p-10 space-y-8 shadow-2xl border border-slate-50" onClick={e => e.stopPropagation()}>
                                <h3 className="text-center text-[10px] font-black uppercase tracking-widest text-slate-300">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã</h3>
                                <input autoFocus className="w-full border-b-2 border-slate-100 py-3 text-center text-sm font-black outline-none focus:border-slate-950 uppercase" placeholder={mixList.map(i => i.name).join('+')} value={mixName} onChange={e => setMixName(e.target.value)} />
                                <button onClick={saveMix} className="w-full py-6 bg-slate-950 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest active:scale-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    )}
                    
                    <canvas ref={hiddenCanvasRef} width={1} height={1} className="hidden" />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
